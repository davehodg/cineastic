use strict;
use warnings;

use Data::Dumper;
use Test::More;
use LWP::Simple;
use URI::Escape;
use JSON;


my $BASE = 'http://localhost:5000/' ;

# first login

ok(my $user = decode_json(get($BASE . '?rm=auth&email=davehodg@me.com&password=password')), "Login") ;
is($user->{email}, 'davehodg@me.com', "Got right email") ;

my $token = $user->{token} ;
my $user_id = $user->{user_id} ;
ok($token, "token") ;

# now get back a movie

ok(my $movie = decode_json(get($BASE . '?rm=movie&title=The+Bourne+Identity+Crisis&year=2003')), "Get movie") ;
is($movie->[0]->{title}, 'The Bourne Identity Crisis',"Right title") ;


my $movie_id = $movie->[0]->{id} ;
ok(my $review = decode_json(get($BASE . "?rm=review&token=$token&wanttosee=1&movie_id=$movie_id&user_id=$user_id")), "Wanttosee") ;

ok(my $review1 = decode_json(get($BASE . "?rm=review&token=$token&wanttosee=0&review=quite+good&rating=5&movie_id=$movie_id&user_id=$user_id")), "Get movie") ;

ok(my $user_reviews = decode_json(get($BASE . "?rm=user_reviews&token=$token&user_id=$user_id")), "Get user review") ;

ok(my $movie_reviews = decode_json(get($BASE . "?rm=movie_reviews&token=$token&movie_id=$movie_id")), "Get movie review") ;

done_testing;
